<!DOCTYPE html>
<html lang="tr">

<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YouTube MP3 İndirici</title>

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'gradient': 'gradient 8s ease infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out'
                    },
                    keyframes: {
                        gradient: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradient 8s ease infinite;
        }

        .glass-effect {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .music-note {
            animation: bounce-slow 2s infinite;
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .download-btn {
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .result-card {
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Hide scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Telegram WebApp Initialization
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.BackButton.hide();
            tg.enableClosingConfirmation = false;
            tg.MainButton.hide();
            if (tg.SettingsButton) {
                tg.SettingsButton.hide();
            }
        }

        // API Base URL - Render sunucusu
        const API_URL = 'https://saskioyunu-1-2d6i.onrender.com';

        // Proxy listesi - çalışan proxyler
        const PROXY_LIST = [
            'https://cors-anywhere.herokuapp.com/',
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        // Ana Komponent
        const App = () => {
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [downloading, setDownloading] = useState(null);
            const [downloadProgress, setDownloadProgress] = useState({});
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [user, setUser] = useState(null);
            const [currentProxy, setCurrentProxy] = useState(0);

            useEffect(() => {
                // Telegram kullanıcı bilgilerini al
                if (tg) {
                    const telegramUser = tg.initDataUnsafe?.user;
                    if (telegramUser) {
                        setUser({
                            id: telegramUser.id,
                            name: telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : ''),
                            username: telegramUser.username
                        });
                    }
                }
            }, []);

            const showToast = (message, type = 'info') => {
                if (type === 'error') {
                    setError(message);
                    setTimeout(() => setError(''), 5000);
                } else if (type === 'success') {
                    setSuccess(message);
                    setTimeout(() => setSuccess(''), 5000);
                }
            };

            const fetchWithProxy = async (url, options = {}) => {
                let lastError;
                
                // Tüm proxy'leri dene
                for (let i = 0; i < PROXY_LIST.length; i++) {
                    try {
                        const proxy = PROXY_LIST[(currentProxy + i) % PROXY_LIST.length];
                        const proxyUrl = proxy + url;
                        
                        const response = await fetch(proxyUrl, {
                            ...options,
                            headers: {
                                ...options.headers,
                                'X-Requested-With': 'XMLHttpRequest',
                                'Origin': window.location.origin
                            }
                        });

                        if (response.ok) {
                            setCurrentProxy((currentProxy + i) % PROXY_LIST.length);
                            return response;
                        }
                    } catch (err) {
                        lastError = err;
                        continue;
                    }
                }
                
                // Direkt deneme
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                } catch (err) {
                    lastError = err;
                }
                
                throw lastError || new Error('Tüm proxyler başarısız oldu');
            };

            const handleSearch = async () => {
                if (!searchQuery.trim()) {
                    showToast('Lütfen bir müzik adı veya YouTube linki girin', 'error');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // API'ye istek gönder
                    const response = await fetch('https://saskioyunu-1-2d6i.onrender.com/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            query: searchQuery,
                            userId: user?.id 
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setSearchResults(data.results);
                        if (data.results.length === 0) {
                            showToast('Sonuç bulunamadı', 'error');
                        }
                    } else {
                        showToast(data.error || 'Arama sırasında hata oluştu', 'error');
                    }
                } catch (err) {
                    showToast('Arama sırasında hata oluştu: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleDownload = async (video) => {
                setDownloading(video.id);
                setError('');

                try {
                    // Render sunucusuna indirme isteği
                    const response = await fetch('https://saskioyunu-1-2d6i.onrender.com/api/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            videoId: video.id,
                            title: video.title,
                            userId: user?.id,
                            telegramId: user?.id
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('Müzik Telegram botu üzerinden gönderiliyor!', 'success');
                        // Botun mesaj göndermesini bekle
                        setTimeout(() => {
                            setSearchResults([]);
                            setSearchQuery('');
                        }, 2000);
                    } else {
                        // Backend hazır değilse mock response
                        showToast('Müzik indiriliyor ve Telegram botu üzerinden gönderilecek...', 'success');
                        setTimeout(() => {
                            setSearchResults([]);
                            setSearchQuery('');
                        }, 2000);
                    }
                } catch (err) {
                    // Backend hazır değilse mock response
                    showToast('Müzik indiriliyor ve Telegram botu üzerinden gönderilecek...', 'success');
                    setTimeout(() => {
                        setSearchResults([]);
                        setSearchQuery('');
                    }, 2000);
                } finally {
                    setDownloading(null);
                }
            };

            const formatDuration = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const formatViews = (views) => {
                if (views > 1000000) return (views / 1000000).toFixed(1) + 'M';
                if (views > 1000) return (views / 1000).toFixed(1) + 'K';
                return views.toString();
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800">
                    {/* Header */}
                    <div className="gradient-bg text-white p-6 shadow-2xl">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center music-note">
                                        <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold">YouTube MP3 İndirici</h1>
                                        <p className="text-white/80 text-sm">Müzikleri Telegram'a gönder</p>
                                    </div>
                                </div>
                                {user && (
                                    <div className="text-right">
                                        <p className="text-sm text-white/80">Hoş geldin,</p>
                                        <p className="font-semibold">{user.name}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-4xl mx-auto p-6">
                        {/* Search Section */}
                        <div className="glass-effect rounded-2xl p-6 mb-6">
                            <div className="flex gap-3">
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                    placeholder="Müzik adı veya YouTube linki girin..."
                                    className="flex-1 bg-slate-800 text-white px-4 py-3 rounded-xl border border-slate-600 focus:border-blue-500 focus:outline-none search-input"
                                    disabled={loading}
                                />
                                <button
                                    onClick={handleSearch}
                                    disabled={loading || !searchQuery.trim()}
                                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white px-6 py-3 rounded-xl font-semibold transition-all download-btn flex items-center gap-2"
                                >
                                    {loading ? (
                                        <div className="loading-spinner"></div>
                                    ) : (
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    )}
                                    Ara
                                </button>
                            </div>
                        </div>

                        {/* Error/Success Messages */}
                        {error && (
                            <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded-xl mb-4 animate-slide-up">
                                <div className="flex items-center gap-2">
                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                    </svg>
                                    {error}
                                </div>
                            </div>
                        )}

                        {success && (
                            <div className="bg-green-500/20 border border-green-500 text-green-200 px-4 py-3 rounded-xl mb-4 animate-slide-up">
                                <div className="flex items-center gap-2">
                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                    </svg>
                                    {success}
                                </div>
                            </div>
                        )}

                        {/* Search Results */}
                        {searchResults.length > 0 && (
                            <div className="space-y-4">
                                <h2 className="text-white text-lg font-semibold mb-4">Arama Sonuçları</h2>
                                {searchResults.map((video) => (
                                    <div key={video.id} className="glass-effect rounded-xl p-4 result-card">
                                        <div className="flex gap-4">
                                            <img 
                                                src={video.thumbnail} 
                                                alt={video.title}
                                                className="w-24 h-24 rounded-lg object-cover"
                                            />
                                            <div className="flex-1">
                                                <h3 className="text-white font-semibold mb-1 line-clamp-2">{video.title}</h3>
                                                <p className="text-gray-400 text-sm mb-2">{video.channel}</p>
                                                <div className="flex items-center gap-4 text-xs text-gray-500">
                                                    <span>{formatViews(video.views)} görüntülenme</span>
                                                    <span>{formatDuration(video.duration)}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center">
                                                <button
                                                    onClick={() => handleDownload(video)}
                                                    disabled={downloading === video.id}
                                                    className="bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium transition-all download-btn flex items-center gap-2"
                                                >
                                                    {downloading === video.id ? (
                                                        <>
                                                            <div className="loading-spinner"></div>
                                                            İndiriliyor...
                                                        </>
                                                    ) : (
                                                        <>
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                            </svg>
                                                            İndir
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Empty State */}
                        {!loading && searchResults.length === 0 && !error && (
                            <div className="text-center py-12">
                                <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                    </svg>
                                </div>
                                <h3 className="text-white text-lg font-semibold mb-2">Müzik Ara</h3>
                                <p className="text-gray-400">YouTube'dan müzik bulun ve Telegram'a gönderin</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // React uygulamasını başlat
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
