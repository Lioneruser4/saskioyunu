<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Oyunu - Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0aec0;
            font-size: 14px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #2f855a 100%);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: #a0aec0;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .room-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .room-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-id {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .room-info {
            color: #a0aec0;
            font-size: 14px;
        }

        .room-settings {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .setting-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .player-list {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid #667eea;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-status {
            font-size: 12px;
            color: #a0aec0;
        }

        .alive {
            color: #48bb78;
        }

        .dead {
            color: #f56565;
            text-decoration: line-through;
        }

        .game-phase {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #4c51bf 0%, #702459 100%);
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .phase-title {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .phase-message {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .phase-timer {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .role-reveal {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .role-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .role-mafia {
            color: #f56565;
        }

        .role-doctor {
            color: #4299e1;
        }

        .role-police {
            color: #48bb78;
        }

        .role-citizen {
            color: #a0aec0;
        }

        .role-description {
            font-size: 16px;
            line-height: 1.5;
            margin: 20px 0;
        }

        .role-abilities {
            list-style: none;
            margin-top: 20px;
        }

        .role-abilities li {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
            border-radius: 10px;
        }

        .chat-container {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #a0aec0;
        }

        .message-content {
            word-break: break-word;
            line-height: 1.4;
        }

        .mafia-chat {
            border-left-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
        }

        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
        }

        .voting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .vote-card {
            text-align: center;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vote-card:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .vote-card.selected {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .vote-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            object-fit: cover;
        }

        .vote-name {
            font-size: 14px;
            font-weight: 600;
        }

        .vote-role {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
            display: none;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification.show {
            display: block;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 32, 44, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            .card {
                padding: 20px;
            }
            
            .phase-timer {
                font-size: 48px;
            }
            
            .voting-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen" class="screen">
            <div class="header">
                <div class="logo">üî´ MAFIA</div>
                <div class="subtitle">Telegram WebApp Mafia Oyunu</div>
            </div>
            
            <div class="card">
                <div style="text-align: center; margin-bottom: 30px;">
                    <img src="" alt="Avatar" id="user-avatar" style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px; border: 4px solid #667eea; object-fit: cover;">
                    <h2 id="user-name">Y√ºkleniyor...</h2>
                    <p id="user-status" style="color: #a0aec0; margin-top: 10px;">Telegram ile giri≈ü yapƒ±lƒ±yor...</p>
                </div>
                
                <button class="btn" id="btn-lobby" style="display: none;">
                    <span>üéÆ Lobiye Git</span>
                </button>
                
                <button class="btn btn-secondary" id="btn-reconnect" style="display: none;">
                    <span>‚Üª Son Odaya D√∂n</span>
                </button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <div class="header">
                <div class="logo">üéÆ LOBBY</div>
                <div class="subtitle">Oda se√ß veya yeni oda kur</div>
            </div>
            
            <div class="card">
                <button class="btn" id="btn-create-room">
                    <span>‚ûï Yeni Oda Kur</span>
                </button>
                
                <div class="input-group">
                    <div class="input-label">Oda Numarasƒ± ile Katƒ±l</div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="room-code" placeholder="√ñrn: ABC123" maxlength="6" style="flex: 1;">
                        <button class="btn" id="btn-join-room" style="width: auto; padding: 15px 25px;">
                            <span>Katƒ±l</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 20px;">üè† Aktif Odalar</h3>
                <div id="rooms-list" class="room-list">
                    <!-- Odalar buraya gelecek -->
                </div>
            </div>
        </div>

        <!-- Create Room Screen -->
        <div id="create-room-screen" class="screen">
            <div class="header">
                <div class="logo">üõ†Ô∏è ODA KUR</div>
                <div class="subtitle">Oyun ayarlarƒ±nƒ± yapƒ±landƒ±r</div>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <div class="input-label">üë§ Mafia Sayƒ±sƒ±</div>
                    <select id="mafia-count">
                        <option value="1">1 Mafia</option>
                        <option value="2" selected>2 Mafia</option>
                        <option value="3">3 Mafia</option>
                        <option value="4">4 Mafia</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <div class="input-label">üè• Doktor Sayƒ±sƒ±</div>
                    <select id="doctor-count">
                        <option value="0">Doktor Yok</option>
                        <option value="1" selected>1 Doktor</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <div class="input-label">üëÆ Polis Sayƒ±sƒ±</div>
                    <select id="police-count">
                        <option value="0">Polis Yok</option>
                        <option value="1" selected>1 Polis</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <div class="input-label">üë• Vatanda≈ü Sayƒ±sƒ±</div>
                    <select id="citizen-count">
                        <option value="3">3 Vatanda≈ü</option>
                        <option value="4">4 Vatanda≈ü</option>
                        <option value="5" selected>5 Vatanda≈ü</option>
                        <option value="6">6 Vatanda≈ü</option>
                        <option value="7">7 Vatanda≈ü</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-secondary" id="btn-cancel-create">
                        <span>‚ùå ƒ∞ptal</span>
                    </button>
                    <button class="btn btn-success" id="btn-create-game">
                        <span>‚úÖ Oda Kur</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Room Screen -->
        <div id="room-screen" class="screen">
            <div class="header">
                <div class="logo" id="room-title">ODA: ---</div>
                <div class="subtitle" id="room-status">Oyuncular bekleniyor...</div>
            </div>
            
            <div id="room-waiting" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">üë• Oyuncular</h3>
                    <div id="room-players" class="player-list">
                        <!-- Oyuncular buraya gelecek -->
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" id="btn-start-game" style="display: none;">
                            <span>‚ñ∂Ô∏è OYUNU BA≈ûLAT</span>
                        </button>
                        
                        <div style="color: #a0aec0; font-size: 14px; text-align: center; margin-top: 20px;">
                            Oyun ba≈ülatmak i√ßin odada en az 5 oyuncu olmalƒ±dƒ±r.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="room-playing" style="display: none;">
                <!-- Oyun ekranƒ± buraya gelecek -->
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <!-- Oyun aray√ºz√º dinamik olarak olu≈üturulacak -->
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottom-nav" style="display: none;">
        <button class="nav-btn" data-screen="lobby">
            <span>üè†</span>
            <span>Lobi</span>
        </button>
        <button class="nav-btn" data-screen="room">
            <span>üéÆ</span>
            <span>Oda</span>
        </button>
        <button class="nav-btn" data-screen="game">
            <span>üî´</span>
            <span>Oyun</span>
        </button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notif-title">Bildirim</div>
        <div class="notification-message" id="notif-message"></div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Global state
        let socket = null;
        let currentUser = null;
        let currentRoom = null;
        let gameState = null;
        let authToken = null;
        let reconnectData = null;
        
        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const notificationEl = document.getElementById('notification');
        const notifTitleEl = document.getElementById('notif-title');
        const notifMessageEl = document.getElementById('notif-message');
        
        // Screens
        const screens = {
            login: document.getElementById('login-screen'),
            lobby: document.getElementById('lobby-screen'),
            createRoom: document.getElementById('create-room-screen'),
            room: document.getElementById('room-screen'),
            game: document.getElementById('game-screen')
        };
        
        // Show notification
        function showNotification(title, message, duration = 3000) {
            notifTitleEl.textContent = title;
            notifMessageEl.textContent = message;
            notificationEl.classList.add('show');
            
            setTimeout(() => {
                notificationEl.classList.remove('show');
            }, duration);
        }
        
        // Show loading
        function showLoading() {
            loadingEl.style.display = 'flex';
        }
        
        // Hide loading
        function hideLoading() {
            loadingEl.style.display = 'none';
        }
        
        // Show screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
            
            // Update bottom nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.screen === screenName);
            });
            
            // Show/hide bottom nav
            const bottomNav = document.getElementById('bottom-nav');
            if (screenName === 'lobby' || screenName === 'room' || screenName === 'game') {
                bottomNav.style.display = 'flex';
            } else {
                bottomNav.style.display = 'none';
            }
        }
        
        // Initialize Telegram authentication
        async function initTelegramAuth() {
            try {
                showLoading();
                
                // Get initData from Telegram
                const initData = tg.initData;
                
                if (!initData) {
                    throw new Error('Telegram verisi y√ºklenemedi');
                }
                
                // Authenticate with server
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ initData })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Authentication failed');
                }
                
                // Save token and user data
                authToken = data.token;
                currentUser = data.user;
                
                // Update UI
                document.getElementById('user-avatar').src = currentUser.photoUrl || 'https://via.placeholder.com/100';
                document.getElementById('user-name').textContent = currentUser.firstName || currentUser.username;
                document.getElementById('user-status').textContent = 'Giri≈ü ba≈üarƒ±lƒ±!';
                
                // Check for reconnection
                const savedRoom = localStorage.getItem('lastRoom');
                if (savedRoom) {
                    reconnectData = JSON.parse(savedRoom);
                    document.getElementById('btn-reconnect').style.display = 'block';
                }
                
                document.getElementById('btn-lobby').style.display = 'block';
                hideLoading();
                
            } catch (error) {
                console.error('Auth error:', error);
                document.getElementById('user-status').textContent = `Hata: ${error.message}`;
                hideLoading();
                
                // Fallback: Allow manual lobby access
                document.getElementById('btn-lobby').style.display = 'block';
                document.getElementById('btn-lobby').textContent = 'Devam Et (Demo Modu)';
            }
        }
        
        // Initialize Socket.IO
        function initSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io({
                reconnection: true,
                reconnectionAttempts: 10,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });
            
            // Connection events
            socket.on('connect', () => {
                console.log('Socket connected:', socket.id);
                
                // Authenticate with token
                if (authToken && currentRoom) {
                    socket.emit('authenticate', {
                        token: authToken,
                        roomId: currentRoom
                    });
                } else if (authToken) {
                    socket.emit('authenticate', {
                        token: authToken,
                        roomId: null
                    });
                }
            });
            
            socket.on('disconnect', (reason) => {
                console.log('Socket disconnected:', reason);
                if (reason === 'io server disconnect') {
                    socket.connect();
                }
            });
            
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                showNotification('Baƒülantƒ± Hatasƒ±', 'Sunucuya baƒülanƒ±lamƒ±yor. Yeniden deneniyor...', 5000);
            });
            
            socket.on('pong', () => {
                // Keep alive
            });
            
            // Authentication
            socket.on('auth-success', (data) => {
                console.log('Authentication successful');
                currentUser = data.user;
                
                if (data.currentRoom) {
                    currentRoom = data.currentRoom;
                    joinRoom(currentRoom);
                } else {
                    showScreen('lobby');
                }
                
                hideLoading();
            });
            
            socket.on('auth-error', (error) => {
                console.error('Auth error:', error);
                showNotification('Kimlik Doƒürulama Hatasƒ±', error);
                hideLoading();
            });
            
            // Lobby updates
            socket.on('lobby-update', (rooms) => {
                updateRoomsList(rooms);
            });
            
            // Room updates
            socket.on('room-update', (roomInfo) => {
                updateRoomInfo(roomInfo);
            });
            
            socket.on('room-created', (data) => {
                showNotification('Oda Kuruldu', `Oda ID: ${data.roomId}`);
                joinRoom(data.roomId);
            });
            
            socket.on('room-error', (error) => {
                showNotification('Oda Hatasƒ±', error);
            });
            
            socket.on('player-joined', (player) => {
                showNotification('Oyuncu Katƒ±ldƒ±', `${player.username} odaya katƒ±ldƒ±`);
            });
            
            socket.on('player-left', (player) => {
                showNotification('Oyuncu Ayrƒ±ldƒ±', `${player.username} odadan ayrƒ±ldƒ±`);
            });
            
            socket.on('player-kicked', (player) => {
                showNotification('Oyuncu Atƒ±ldƒ±', `${player.playerName} odadan atƒ±ldƒ±`);
            });
            
            socket.on('player-disconnected', (player) => {
                showNotification('Baƒülantƒ± Kesildi', `${player.playerName} baƒülantƒ±sƒ± koptu`);
            });
            
            socket.on('player-reconnected', (player) => {
                showNotification('Baƒülantƒ± Kuruldu', `${player.username} tekrar baƒülandƒ±`);
            });
            
            socket.on('kicked', (message) => {
                showNotification('Atƒ±ldƒ±nƒ±z', message);
                currentRoom = null;
                localStorage.removeItem('lastRoom');
                showScreen('lobby');
            });
            
            // Game events
            socket.on('game-started', (data) => {
                showNotification('Oyun Ba≈üladƒ±!', 'Rolleriniz daƒüƒ±tƒ±lƒ±yor...');
                startGame(data);
            });
            
            socket.on('your-role', (data) => {
                showRoleReveal(data);
            });
            
            socket.on('mafia-team', (mafias) => {
                showMafiaTeam(mafias);
            });
            
            socket.on('phase-changed', (data) => {
                updateGamePhase(data);
            });
            
            socket.on('night-result', (data) => {
                showNightResult(data);
            });
            
            socket.on('vote-result', (data) => {
                showVoteResult(data);
            });
            
            socket.on('game-ended', (data) => {
                endGame(data);
            });
            
            socket.on('day-chat', (message) => {
                addChatMessage(message, false);
            });
            
            socket.on('mafia-chat', (message) => {
                addChatMessage(message, true);
            });
            
            socket.on('mafia-chat-enabled', (enabled) => {
                if (enabled) {
                    showMafiaChat();
                }
            });
            
            socket.on('mafia-action', (data) => {
                showNotification('Mafia Hareketi', `${data.mafiaName} hedef se√ßti`);
            });
            
            socket.on('action-confirmed', (message) => {
                showNotification('Onaylandƒ±', message);
            });
            
            socket.on('police-result', (data) => {
                showPoliceResult(data);
            });
            
            socket.on('game-state', (state) => {
                restoreGameState(state);
            });
            
            socket.on('error', (message) => {
                showNotification('Hata', message);
            });
        }
        
        // Update rooms list
        function updateRoomsList(rooms) {
            const roomsList = document.getElementById('rooms-list');
            roomsList.innerHTML = '';
            
            if (rooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #a0aec0;">
                        Aktif oda bulunamadƒ±. ƒ∞lk odayƒ± sen kur!
                    </div>
                `;
                return;
            }
            
            rooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = 'room-card';
                roomEl.innerHTML = `
                    <div class="room-header">
                        <div class="room-id">${room.id}</div>
                        <div class="room-info">${room.players}/${room.maxPlayers} üë•</div>
                    </div>
                    <div>Kurucu: ${room.owner}</div>
                    <div class="room-settings">
                        <span class="setting-badge">${room.settings.mafiaCount} Mafia</span>
                        ${room.settings.doctorCount > 0 ? `<span class="setting-badge">${room.settings.doctorCount} Doktor</span>` : ''}
                        ${room.settings.policeCount > 0 ? `<span class="setting-badge">${room.settings.policeCount} Polis</span>` : ''}
                        <span class="setting-badge">${room.settings.citizenCount} Vatanda≈ü</span>
                    </div>
                `;
                
                roomEl.addEventListener('click', () => {
                    joinRoom(room.id);
                });
                
                roomsList.appendChild(roomEl);
            });
        }
        
        // Join room
        function joinRoom(roomId) {
            showLoading();
            currentRoom = roomId.toUpperCase();
            
            // Save to localStorage for reconnection
            localStorage.setItem('lastRoom', JSON.stringify({
                roomId: currentRoom,
                timestamp: Date.now()
            }));
            
            socket.emit('join-room', roomId);
            showScreen('room');
            hideLoading();
        }
        
        // Update room info
        function updateRoomInfo(roomInfo) {
            document.getElementById('room-title').textContent = `ODA: ${roomInfo.id}`;
            document.getElementById('room-status').textContent = 
                roomInfo.gameState === 'waiting' ? 'Oyuncular bekleniyor...' : 'Oyun devam ediyor...';
            
            const waitingDiv = document.getElementById('room-waiting');
            const playingDiv = document.getElementById('room-playing');
            
            if (roomInfo.gameState === 'waiting') {
                waitingDiv.style.display = 'block';
                playingDiv.style.display = 'none';
                
                // Update players list
                const playersList = document.getElementById('room-players');
                playersList.innerHTML = '';
                
                roomInfo.players.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'player-card';
                    playerEl.innerHTML = `
                        <img src="${player.photoUrl || 'https://via.placeholder.com/50'}" class="player-avatar">
                        <div class="player-info">
                            <div class="player-name">
                                ${player.username}
                                ${player.isOwner ? ' üëë' : ''}
                            </div>
                            <div class="player-status">
                                ${player.id === currentUser.id ? '(Siz)' : ''}
                            </div>
                        </div>
                    `;
                    
                    // Add kick button for owner
                    if (roomInfo.owner === currentUser.id && player.id !== currentUser.id) {
                        const kickBtn = document.createElement('button');
                        kickBtn.className = 'btn-danger';
                        kickBtn.style.padding = '8px 15px';
                        kickBtn.style.fontSize = '12px';
                        kickBtn.textContent = 'At';
                        kickBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            socket.emit('kick-player', player.id);
                        });
                        playerEl.appendChild(kickBtn);
                    }
                    
                    playersList.appendChild(playerEl);
                });
                
                // Show/hide start button
                const startBtn = document.getElementById('btn-start-game');
                const totalPlayers = roomInfo.settings.mafiaCount + roomInfo.settings.doctorCount + 
                                   roomInfo.settings.policeCount + roomInfo.settings.citizenCount;
                
                if (roomInfo.owner === currentUser.id && roomInfo.players.length >= totalPlayers) {
                    startBtn.style.display = 'block';
                } else {
                    startBtn.style.display = 'none';
                }
                
            } else {
                waitingDiv.style.display = 'none';
                playingDiv.style.display = 'block';
            }
        }
        
        // Start game
        function startGame(data) {
            showScreen('game');
            
            const gameScreen = document.getElementById('game-screen');
            gameScreen.innerHTML = `
                <div id="game-container"></div>
            `;
        }
        
        // Show role reveal
        function showRoleReveal(data) {
            const gameContainer = document.getElementById('game-container');
            
            gameContainer.innerHTML = `
                <div class="role-reveal">
                    <div class="role-title ${'role-' + data.role}">
                        ${getRoleName(data.role)}
                    </div>
                    <div class="role-description">
                        ${data.description}
                    </div>
                    <ul class="role-abilities">
                        ${data.abilities.map(ability => `<li>${ability}</li>`).join('')}
                    </ul>
                    <button class="btn" id="btn-continue" style="margin-top: 30px;">
                        <span>Devam Et</span>
                    </button>
                </div>
            `;
            
            document.getElementById('btn-continue').addEventListener('click', () => {
                gameContainer.innerHTML = `
                    <div id="phase-container"></div>
                    <div id="game-content"></div>
                `;
            });
        }
        
        // Show mafia team
        function showMafiaTeam(mafias) {
            if (mafias.length > 1) {
                const gameContainer = document.getElementById('game-container');
                
                gameContainer.innerHTML += `
                    <div class="card" style="margin-top: 20px;">
                        <h3>üë• Mafia Takƒ±mƒ±</h3>
                        <div class="player-list">
                            ${mafias.map(mafia => `
                                <div class="player-card">
                                    <img src="${mafia.photoUrl || 'https://via.placeholder.com/50'}" class="player-avatar">
                                    <div class="player-info">
                                        <div class="player-name">${mafia.username}</div>
                                        <div class="player-status">Mafia</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }
        
        // Update game phase
        function updateGamePhase(data) {
            const phaseContainer = document.getElementById('phase-container');
            const gameContent = document.getElementById('game-content');
            
            // Update phase display
            phaseContainer.innerHTML = `
                <div class="game-phase">
                    <div class="phase-title">
                        ${data.phase === 'night' ? 'üåô GECE' : 
                          data.phase === 'day' ? '‚òÄÔ∏è G√úND√úZ' : 
                          data.phase === 'voting' ? 'üó≥Ô∏è OYLAMA' : ''}
                    </div>
                    <div class="phase-message">${data.message}</div>
                    <div class="phase-timer" id="phase-timer">${data.timer || '--'}</div>
                    <div>G√ºn ${data.dayNumber}</div>
                </div>
            `;
            
            // Update game content based on phase
            if (data.phase === 'night') {
                showNightPhase();
            } else if (data.phase === 'day') {
                showDayPhase();
            } else if (data.phase === 'voting') {
                showVotingPhase();
            }
            
            // Start timer
            if (data.timer) {
                startTimer(data.timer);
            }
        }
        
        // Show night phase
        function showNightPhase() {
            const gameContent = document.getElementById('game-content');
            
            // Get player role
            // This would come from game state
            const role = 'citizen'; // Placeholder
            
            if (role === 'mafia') {
                gameContent.innerHTML = `
                    <div class="card">
                        <h3>üéØ Birini √ñld√ºr</h3>
                        <div id="night-targets" class="voting-grid"></div>
                        <div id="mafia-chat-container" style="margin-top: 30px;">
                            <h3>üí¨ Mafia Sohbeti</h3>
                            <div class="chat-container" id="mafia-chat"></div>
                            <div class="chat-input-container">
                                <input type="text" class="chat-input" id="mafia-chat-input" placeholder="Mafialarla konu≈ü...">
                                <button class="chat-send" id="mafia-chat-send">G√∂nder</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load targets
                loadNightTargets();
                
                // Setup mafia chat
                document.getElementById('mafia-chat-send').addEventListener('click', () => {
                    const input = document.getElementById('mafia-chat-input');
                    const message = input.value.trim();
                    if (message) {
                        socket.emit('send-chat', { message, isMafiaChat: true });
                        input.value = '';
                    }
                });
                
            } else if (role === 'doctor') {
                gameContent.innerHTML = `
                    <div class="card">
                        <h3>üè• Birini Tedavi Et</h3>
                        <div id="doctor-targets" class="voting-grid"></div>
                    </div>
                `;
                
                loadDoctorTargets();
                
            } else if (role === 'police') {
                gameContent.innerHTML = `
                    <div class="card">
                        <h3>üëÆ Birini Kontrol Et</h3>
                        <div id="police-targets" class="voting-grid"></div>
                    </div>
                `;
                
                loadPoliceTargets();
                
            } else {
                gameContent.innerHTML = `
                    <div class="card">
                        <h3>üò¥ Uyuyorsun</h3>
                        <p style="text-align: center; padding: 30px; color: #a0aec0;">
                            Gece vakti... Sabah olmasƒ±nƒ± bekliyorsun.
                        </p>
                    </div>
                `;
            }
        }
        
        // Show day phase
        function showDayPhase() {
            const gameContent = document.getElementById('game-content');
            
            gameContent.innerHTML = `
                <div class="card">
                    <h3>üí¨ Tartƒ±≈üma</h3>
                    <div class="chat-container" id="day-chat"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="day-chat-input" placeholder="Herkesle konu≈ü...">
                        <button class="chat-send" id="day-chat-send">G√∂nder</button>
                    </div>
                </div>
            `;
            
            // Setup day chat
            document.getElementById('day-chat-send').addEventListener('click', () => {
                const input = document.getElementById('day-chat-input');
                const message = input.value.trim();
                if (message) {
                    socket.emit('send-chat', { message, isMafiaChat: false });
                    input.value = '';
                }
            });
        }
        
        // Show voting phase
        function showVotingPhase() {
            const gameContent = document.getElementById('game-content');
            
            gameContent.innerHTML = `
                <div class="card">
                    <h3>üó≥Ô∏è Kimden ≈û√ºpheleniyorsun?</h3>
                    <div id="voting-targets" class="voting-grid"></div>
                </div>
            `;
            
            loadVotingTargets();
        }
        
        // Load night targets
        function loadNightTargets() {
            // This would load from game state
            const targets = [
                { id: '1', name: 'Player 1', photo: '' },
                { id: '2', name: 'Player 2', photo: '' }
            ];
            
            const container = document.getElementById('night-targets');
            container.innerHTML = '';
            
            targets.forEach(target => {
                const card = document.createElement('div');
                card.className = 'vote-card';
                card.innerHTML = `
                    <img src="${target.photo || 'https://via.placeholder.com/60'}" class="vote-avatar">
                    <div class="vote-name">${target.name}</div>
                `;
                
                card.addEventListener('click', () => {
                    socket.emit('mafia-vote', target.id);
                    document.querySelectorAll('#night-targets .vote-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    card.classList.add('selected');
                });
                
                container.appendChild(card);
            });
        }
        
        // Load doctor targets
        function loadDoctorTargets() {
            // Similar to loadNightTargets but for doctor
        }
        
        // Load police targets
        function loadPoliceTargets() {
            // Similar to loadNightTargets but for police
        }
        
        // Load voting targets
        function loadVotingTargets() {
            // Similar to loadNightTargets but for voting
        }
        
        // Show night result
        function showNightResult(data) {
            const gameContainer = document.getElementById('game-container');
            
            gameContainer.innerHTML += `
                <div class="card" style="margin-top: 20px; animation: pulse 2s;">
                    <h3>üåÖ Sabah Sonu√ßlarƒ±</h3>
                    <p style="text-align: center; padding: 20px; font-size: 18px;">
                        ${data.message}
                    </p>
                    ${data.killedPlayer ? `
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="font-size: 24px; color: #f56565;">‚ò†Ô∏è ${data.killedPlayer.name}</div>
                            <div style="color: #a0aec0; margin-top: 10px;">Rol√º: ${data.killedPlayer.role}</div>
                        </div>
                    ` : ''}
                    ${data.savedPlayer ? `
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="font-size: 24px; color: #48bb78;">üíâ ${data.savedPlayer.name}</div>
                            <div style="color: #a0aec0; margin-top: 10px;">Doktor tarafƒ±ndan kurtarƒ±ldƒ±!</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Show vote result
        function showVoteResult(data) {
            const gameContainer = document.getElementById('game-container');
            
            gameContainer.innerHTML += `
                <div class="card" style="margin-top: 20px;">
                    <h3>üìä Oylama Sonucu</h3>
                    <p style="text-align: center; padding: 20px; font-size: 18px;">
                        ${data.message}
                    </p>
                    ${data.executedPlayer ? `
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="font-size: 24px; color: #f56565;">ü™¢ ${data.executedPlayer.name}</div>
                            <div style="color: #a0aec0; margin-top: 10px;">Rol√º: ${data.executedPlayer.role}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Show police result
        function showPoliceResult(data) {
            showNotification('Polis Sonucu', 
                `${data.targetName} ${data.isMafia ? 'MAFIA!' : 'masum g√∂r√ºn√ºyor.'}`);
        }
        
        // End game
        function endGame(data) {
            const gameScreen = document.getElementById('game-screen');
            
            gameScreen.innerHTML = `
                <div class="game-phase" style="background: ${data.winner === 'citizens' ? 'linear-gradient(135deg, #48bb78 0%, #2f855a 100%)' : 'linear-gradient(135deg, #f56565 0%, #c53030 100%)'};">
                    <div class="phase-title">${data.winner === 'citizens' ? 'üéâ VATANDA≈ûLAR KAZANDI!' : 'üòà MAFƒ∞ALAR KAZANDI!'}</div>
                    <div class="phase-message">${data.message}</div>
                </div>
                
                <div class="card">
                    <h3>üë• T√ºm Roller</h3>
                    <div class="player-list">
                        ${data.playerRoles.map(player => `
                            <div class="player-card">
                                <img src="${player.photoUrl || 'https://via.placeholder.com/50'}" class="player-avatar">
                                <div class="player-info">
                                    <div class="player-name ${player.isAlive ? 'alive' : 'dead'}">
                                        ${player.name}
                                        ${player.isAlive ? ' ‚ù§Ô∏è' : ' ‚ò†Ô∏è'}
                                    </div>
                                    <div class="player-status ${'role-' + player.role}">
                                        ${player.roleName}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn btn-secondary" id="btn-back-to-lobby">
                        <span>üè† Lobiye D√∂n</span>
                    </button>
                    <button class="btn" id="btn-play-again">
                        <span>üîÑ Tekrar Oyna</span>
                    </button>
                </div>
            `;
            
            document.getElementById('btn-back-to-lobby').addEventListener('click', () => {
                currentRoom = null;
                localStorage.removeItem('lastRoom');
                showScreen('lobby');
            });
            
            document.getElementById('btn-play-again').addEventListener('click', () => {
                showScreen('lobby');
            });
        }
        
        // Restore game state
        function restoreGameState(state) {
            // Implement game state restoration
            console.log('Restoring game state:', state);
        }
        
        // Start timer
        function startTimer(seconds) {
            let timeLeft = seconds;
            const timerEl = document.getElementById('phase-timer');
            
            if (!timerEl) return;
            
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }
        
        // Add chat message
        function addChatMessage(message, isMafiaChat) {
            const chatId = isMafiaChat ? 'mafia-chat' : 'day-chat';
            const chatEl = document.getElementById(chatId);
            
            if (!chatEl) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${isMafiaChat ? 'mafia-chat' : ''}`;
            messageEl.innerHTML = `
                <div class="message-header">
                    <span>${message.username}</span>
                    <span>${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">${message.message}</div>
            `;
            
            chatEl.appendChild(messageEl);
            chatEl.scrollTop = chatEl.scrollHeight;
        }
        
        // Show mafia chat
        function showMafiaChat() {
            const mafiaChatEl = document.getElementById('mafia-chat-container');
            if (mafiaChatEl) {
                mafiaChatEl.style.display = 'block';
            }
        }
        
        // Get role name
        function getRoleName(role) {
            const names = {
                mafia: 'Mafia',
                doctor: 'Doktor',
                police: 'Polis',
                citizen: 'Vatanda≈ü'
            };
            return names[role] || role;
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize
            initSocket();
            initTelegramAuth();
            
            // Bottom nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showScreen(btn.dataset.screen);
                });
            });
            
            // Login screen buttons
            document.getElementById('btn-lobby').addEventListener('click', () => {
                showScreen('lobby');
            });
            
            document.getElementById('btn-reconnect').addEventListener('click', async () => {
                if (reconnectData) {
                    showLoading();
                    try {
                        const response = await fetch('/api/reconnect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                token: authToken,
                                roomId: reconnectData.roomId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            currentRoom = reconnectData.roomId;
                            socket.emit('authenticate', {
                                token: authToken,
                                roomId: currentRoom
                            });
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        showNotification('Hata', 'Yeniden baƒülanƒ±lamadƒ±: ' + error.message);
                        hideLoading();
                    }
                }
            });
            
            // Lobby screen buttons
            document.getElementById('btn-create-room').addEventListener('click', () => {
                showScreen('createRoom');
            });
            
            document.getElementById('btn-join-room').addEventListener('click', () => {
                const roomCode = document.getElementById('room-code').value.trim();
                if (roomCode.length === 6) {
                    joinRoom(roomCode);
                } else {
                    showNotification('Hata', 'Ge√ßerli bir oda kodu girin (6 karakter)');
                }
            });
            
            // Create room screen buttons
            document.getElementById('btn-cancel-create').addEventListener('click', () => {
                showScreen('lobby');
            });
            
            document.getElementById('btn-create-game').addEventListener('click', () => {
                const settings = {
                    mafiaCount: document.getElementById('mafia-count').value,
                    doctorCount: document.getElementById('doctor-count').value,
                    policeCount: document.getElementById('police-count').value,
                    citizenCount: document.getElementById('citizen-count').value
                };
                
                socket.emit('create-room', settings);
            });
            
            // Room screen buttons
            document.getElementById('btn-start-game').addEventListener('click', () => {
                socket.emit('start-game');
            });
            
            // Auto-focus room code input
            document.getElementById('room-code')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('btn-join-room').click();
                }
            });
        });
        
        // Keep connection alive
        setInterval(() => {
            if (socket && socket.connected) {
                socket.emit('ping');
            }
        }, 25000);
        
        // Keep Render awake
        setInterval(() => {
            fetch('/ping').catch(() => {});
        }, 30000);
    </script>
</body>
</html>
